"use strict";var __assign=this&&this.__assign||function(){return __assign=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var o in r=arguments[t])Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o]);return e},__assign.apply(this,arguments)},__awaiter=this&&this.__awaiter||function(e,r,t,n){return new(t||(t=Promise))((function(o,i){function c(e){try{s(n.next(e))}catch(e){i(e)}}function a(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var r;e.done?o(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(c,a)}s((n=n.apply(e,r||[])).next())}))},__generator=this&&this.__generator||function(e,r){var t,n,o,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=a(0),c.throw=a(1),c.return=a(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function a(a){return function(s){return function(a){if(t)throw new TypeError("Generator is already executing.");for(;c&&(c=0,a[0]&&(i=0)),i;)try{if(t=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,n=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=r.call(e,i)}catch(e){a=[6,e],n=0}finally{t=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}};Object.defineProperty(exports,"__esModule",{value:!0});var net_1=require("net"),child_process_1=require("child_process"),crypto_1=require("crypto"),token=process.argv[2];token||(console.error("Token must be provided as the first argument"),process.exit(1));var portArg=process.argv[3]||"0",port=0;function parsePortRange(e){if("0"===e||""===e)return 0;var r=e.match(/^(\d+)-(\d+)$/);if(r){var t=parseInt(r[1],10),n=parseInt(r[2],10);return t>=n&&(console.error("Invalid port range: ".concat(e,". Start port must be less than end port.")),process.exit(1)),(t<1||n>65535)&&(console.error("Invalid port range: ".concat(e,". Ports must be between 1 and 65535.")),process.exit(1)),{start:t,end:n}}var o=parseInt(e,10);return(isNaN(o)||o<0||o>65535)&&(console.error("Invalid port: ".concat(e)),process.exit(1)),o}function findFreePortInRange(e,r){return __awaiter(this,void 0,void 0,(function(){var t,n,o,i;return __generator(this,(function(c){switch(c.label){case 0:t=require("net"),n=function(e){return __generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,new Promise((function(r,n){var o=t.createServer();o.listen(e,"127.0.0.1",(function(){o.close(),r()})).on("error",(function(){n()}))}))];case 1:return r.sent(),[2,{value:e}];case 2:return r.sent(),[3,3];case 3:return[2]}}))},o=e,c.label=1;case 1:return o<=r?[5,n(o)]:[3,4];case 2:if("object"==typeof(i=c.sent()))return[2,i.value];c.label=3;case 3:return o++,[3,1];case 4:throw new Error("No free port found in range ".concat(e,"-").concat(r))}}))}))}function initializePort(){return __awaiter(this,void 0,void 0,(function(){var e,r,t;return __generator(this,(function(n){switch(n.label){case 0:return"number"!=typeof(e=parsePortRange(portArg))?[3,1]:[2,e];case 1:return n.trys.push([1,3,,4]),[4,findFreePortInRange(e.start,e.end)];case 2:return r=n.sent(),console.log("Found free port ".concat(r," in range ").concat(e.start,"-").concat(e.end)),[2,r];case 3:return t=n.sent(),console.error("Failed to find free port: ".concat(t)),process.exit(1),[3,4];case 4:return[2]}}))}))}var DEFAULT_SHUTDOWN_TIMEOUT_MS=3e5,SHUTDOWN_TIMEOUT_MS=DEFAULT_SHUTDOWN_TIMEOUT_MS;process.env.VSCODE_SERVER_SHUTDOWN_TIMEOUT&&(SHUTDOWN_TIMEOUT_MS=1e3*parseInt(process.env.VSCODE_SERVER_SHUTDOWN_TIMEOUT,10),isNaN(SHUTDOWN_TIMEOUT_MS)&&(console.error("Invalid VSCODE_SERVER_SHUTDOWN_TIMEOUT: ".concat(process.env.VSCODE_SERVER_SHUTDOWN_TIMEOUT)),SHUTDOWN_TIMEOUT_MS=DEFAULT_SHUTDOWN_TIMEOUT_MS));var inactivityTimer,server=(0,net_1.createServer)({keepAlive:!0},(function(e){console.log("Server received connection"),resetInactivityTimer();var r,t,n=Buffer.alloc(0);e.on("close",(function(){console.log("[remoteServer][".concat(t,"] Socket closed; killing child process")),r&&r.pid&&!r.killed&&((null==r?void 0:r.kill())||console.error("[remoteServer][".concat(t,"] Failed to kill child process")))})),e.on("data",(function(o){var i,c,a;if(n=Buffer.concat([n,o]),void 0===r){var s=n.indexOf(Buffer.from("\n"));if(-1===s)return;var l=n.subarray(0,s).toString();n=n.subarray(s+1);var u=void 0;try{u=JSON.parse(l)}catch(r){return console.error("Error parsing JSON command:",r),void e.destroy()}if(u.token!==token)return console.error("Invalid token:",u.token),e.write(JSON.stringify({type:"exit",code:401})+"\n"),void e.end();t=null!==(i=u.id)&&void 0!==i?i:(0,crypto_1.randomUUID)(),console.log("[command][".concat(t,"] Executing command: ").concat(u.command," ").concat((null!==(c=u.args)&&void 0!==c?c:[]).join(" "))),(r=(0,child_process_1.spawn)(u.command,null!==(a=u.args)&&void 0!==a?a:[],{env:__assign(__assign({},process.env),u.env),cwd:u.cwd,shell:!1,stdio:"pipe"})).stdout.on("data",(function(r){var t={type:"stdout",data:r.toString("base64")};e.write(JSON.stringify(t)+"\n")})),r.stdout.on("end",(function(){e.write(JSON.stringify({type:"stdout-end"})+"\n")})),r.stderr.on("data",(function(r){var t={type:"stderr",data:r.toString("base64")};e.write(JSON.stringify(t)+"\n")})),r.stderr.on("end",(function(){e.write(JSON.stringify({type:"stderr-end"})+"\n")}));var d=!1;r.on("error",(function(r){d?console.log("[command][".concat(t,"] Process exited with error but we already sent an exit message"),r):(d=!0,console.error("[command][".concat(t,"] Process error"),r),e.write(JSON.stringify({type:"exit",code:1})+"\n"),e.end())})),r.on("exit",(function(r){if(d)console.log("[command][".concat(t,"] Process exited with code ").concat(r," but we already sent an exit message"));else{d=!0,console.log("[command][".concat(t,"] Process exited with code ").concat(r,". Sending exit message"));var n={type:"exit",code:null!==r?r:0};e.write(JSON.stringify(n)+"\n"),e.end()}}))}var f=n.indexOf(0);if(-1!==f){var p=n.subarray(0,f);try{var v=Buffer.from(p.toString("utf-8"),"base64");r.stdin.write(v)}catch(t){return console.error("Error decoding base64 data:",t),e.destroy(),void r.kill("SIGKILL")}return r.stdin.end(),void(n=Buffer.alloc(0))}var _=4*Math.floor(n.length/4);if(0!==_){var g=n.subarray(0,_);n=n.subarray(_);try{v=Buffer.from(g.toString("utf-8"),"base64"),r.stdin.write(v)}catch(t){return console.error("Error decoding base64 data:",t),r.kill("SIGKILL"),void e.destroy()}}})),e.on("error",(function(e){console.error("[remoteServer][".concat(t,"] Socket error:"),e),r&&r.kill("SIGKILL")}))}));function resetInactivityTimer(){inactivityTimer&&clearTimeout(inactivityTimer),inactivityTimer=setTimeout((function(){console.error("No connections received for ".concat(SHUTDOWN_TIMEOUT_MS/1e3," seconds, shutting down...")),process.exit(0)}),SHUTDOWN_TIMEOUT_MS)}resetInactivityTimer(),initializePort().then((function(e){port=e,server.listen({host:"127.0.0.1",port},(function(){var e=server.address();null===e&&(console.error("Failed to get server address"),process.exit(1)),"string"==typeof e&&(console.error("Invalid address: ".concat(e)),process.exit(1)),console.log("Server listening on ".concat(e.port))}))})).catch((function(e){console.error("Failed to initialize port:",e),process.exit(1)})),process.on("SIGINT",(function(){server.close((function(){console.log("Server closed"),process.exit(0)}))}));